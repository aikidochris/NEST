-- =============================================================================
-- TEST DATA: Sample conversation + images for local testing
-- Run this AFTER the migration has been applied
-- Replace UUIDs with actual values from your local database
-- =============================================================================

-- Get a sample property and user (adjust these queries for your data)
-- SELECT id FROM properties LIMIT 1;
-- SELECT id FROM auth.users LIMIT 1;

-- Example with placeholder UUIDs (replace with real ones):
DO $$
DECLARE
    v_property_id UUID := 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa';  -- Replace with real property ID
    v_owner_id UUID := 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb';     -- Replace with property owner's user ID
    v_viewer_id UUID := 'cccccccc-cccc-cccc-cccc-cccccccccccc';    -- Replace with another user's ID
    v_conversation_id UUID;
    v_image_id UUID;
BEGIN
    -- 1) Insert sample property images
    INSERT INTO property_images (property_id, url, kind, album_key, visibility, sort_order)
    VALUES 
        (v_property_id, 'https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=800', 'cover', NULL, 'public', 0),
        (v_property_id, 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800', 'album', 'kitchen', 'public', 1),
        (v_property_id, 'https://images.unsplash.com/photo-1556909114-44e3e70034e2?w=800', 'album', 'living', 'chat_unlocked', 2),
        (v_property_id, 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800', 'album', 'garden', 'private', 3);

    RAISE NOTICE 'Inserted 4 sample images for property %', v_property_id;

    -- 2) Create a conversation
    INSERT INTO conversations (property_id, owner_user_id, created_by_user_id)
    VALUES (v_property_id, v_owner_id, v_viewer_id)
    RETURNING id INTO v_conversation_id;

    RAISE NOTICE 'Created conversation %', v_conversation_id;

    -- 3) Add participants
    INSERT INTO conversation_participants (conversation_id, user_id, role)
    VALUES 
        (v_conversation_id, v_owner_id, 'owner'),
        (v_conversation_id, v_viewer_id, 'viewer');

    RAISE NOTICE 'Added participants';

    -- 4) Insert sample messages
    INSERT INTO messages (conversation_id, sender_user_id, body)
    VALUES 
        (v_conversation_id, v_viewer_id, 'Hi! I saw your home on Nest and love the area. Would you mind sharing more photos?'),
        (v_conversation_id, v_owner_id, 'Thanks for reaching out! Happy to share some photos of the living room.');

    RAISE NOTICE 'Added sample messages';

    -- 5) Create an album unlock (owner shares the living room album)
    INSERT INTO conversation_album_unlocks (conversation_id, property_id, album_key, unlocked_by_user_id)
    VALUES (v_conversation_id, v_property_id, 'living', v_owner_id);

    RAISE NOTICE 'Created album unlock for living room';

    RAISE NOTICE 'Test data created successfully!';
END $$;

-- =============================================================================
-- VERIFY: Check the data
-- =============================================================================

-- View property images
-- SELECT * FROM property_images WHERE property_id = 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa';

-- View conversation
-- SELECT c.*, p.display_label FROM conversations c 
-- JOIN properties p ON p.id = c.property_id;

-- View messages
-- SELECT m.body, m.sender_user_id, m.created_at FROM messages m ORDER BY created_at;

-- View unlocks
-- SELECT * FROM conversation_album_unlocks;
